{{ $globs := slice }}
{{ range resources.Match "sources/*/defs.{yaml,json}" }}
  {{ $path := .String }}
  {{ $book := index (index (findRESubmatch `^/sources/([a-z\-]+)/` $path 1) 0) 1 }}
  {{ range $type, $v := (transform.Unmarshal .) }}
    {{ range $v }}
      {{ $glob := printf "regole/%s/%s" $book . }}
      {{ $regex := partial "utils/globToRegex" $glob }}
      {{ $globs = $globs | append (dict
        "glob" $glob
        "regex" $regex
        "type" $type
        )
      }}
    {{ end }}
  {{ end }}
{{ end }}

{{ range $globs }}
  {{/* warnf "%s %q %q" .type .glob .regex */}}
{{ end }}

{{ $addedPages := collections.NewScratch }}
{{ $addedResources := collections.NewScratch }}

{{ range resources.Match "sources/**/*.md" }}
  {{ $path := .String | replaceRE `(\.md$|/_index\.md$)` "" | replaceRE `^/sources/` "regole/" }}
  {{ $book := index (index (findRESubmatch `^regole/([a-z\-]+)/` $path 1) 0) 1 }}

  {{ $splitContent := findRESubmatch `^(?:---\r?\n\s*([\s\S]*?)\s*\r?\n---\r?\n)?\s*([\s\S]*)$` .Content 1 }}
  {{ $rawFrontmatter := (index (index $splitContent 0) 1) }}
  {{ $content := (index (index $splitContent 0) 2) }}

  {{ $frontmatter := transform.Unmarshal (dict "format" "yaml") $rawFrontmatter }}

  {{ $config := (partialCached "config" "") }}
  {{ $editURL := printf "%s/blob/%s" $config.repoURL $config.repoBranch }}
  {{ $editURL = urls.JoinPath $editURL .String }}

  {{ $params := merge $frontmatter (dict "editURL" $editURL) }}

  {{ $title := partial "utils/titleMd" (dict "content" $content) }}
  {{ $kind := cond (hasSuffix .String "_index.md") "section" "page" }}
  {{ $pftype := default nil nil }}
  {{ $type := "page" }}

  {{ if isset $params "type" }}
    {{ $pftype = $params.type }}
    {{ $type = print "pf" .type }}
  {{ else }}
    {{ range $globs }}
      {{ if findRE .regex $path }}
        {{ $pftype = .type }}
        {{ $type = print "pf" .type }}
        {{ break }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ $canonicalPath := partial "contentAdapterPathByType" (dict "path" $path "type" $pftype "params" $params) }}
  {{ if $canonicalPath }}
    {{ if isset $params "slug" }}
      {{ $pathDir := path.Dir $canonicalPath }}
      {{ $canonicalPath = path.Join $pathDir $params.slug }}
    {{ end }}
    {{ $params = merge $params (dict "canonicalURL" $canonicalPath) }}
  {{ end }}

  {{/* if $pftype }}
    {{ warnf "%s %s" $path $canonicalPath }}
  {{ end */}}

  {{ $params = merge $params (dict "parsedTitle" $title) }}

  {{ partial "contentAdapter/addPage" (dict
    "context" $
    "addedPages" $addedPages
    "content" $content
    "kind" $kind
    "type" $type
    "path" $path
    "params" $params
    )
  }}

  {{ if $canonicalPath }}
    {{ $variants := $addedResources.Get $canonicalPath | default (slice) }}
    {{ $variant := dict
      "original" (dict "path" $path)
      "path" $canonicalPath
      "type" $pftype
      "kind" $kind
      "content" $content
      "params" $params
      "title" $title
    }}
    {{ $variants := $variants | append $variant }}
    {{ $addedResources.Set $canonicalPath $variants }}
  {{ end }}
{{ end }}

{{ range $k, $v := $addedResources.Values }}
  {{ if gt (len $v) 1 }}
    {{ warnf "duplicate page: %q" $k }}
    {{ range $v }}
      {{ warnf "- %q" .original.path }}
    {{ end }}
  {{ end }}
{{ end }}

{{ range $k, $v := $addedResources.Values }}
  {{ with index $v 0 }}
    {{ $content := .content }}

    {{ partial "contentAdapter/addPage" (dict
      "context" $
      "addedPages" $addedPages
      "content" $content
      "kind" .kind
      "type" (print "pf" .type)
      "path" .path
      "params" .params
      )
    }}

    {{ if eq .type "class" }}
      {{ $featsPage := $addedPages.Get (printf "%s/talenti" .original.path) }}
      {{ if $featsPage }}
        {{ $class := index (split .path "/" | last 1) 0 }}
        {{ $featsPageContent := $featsPage.content.value }}
        {{ $replacement := printf `$1 featTable traits="%s" $2` $class }}
        {{ $featsPageContent = $featsPageContent |
          replaceRE `(\{\{<)\s*rulesFeatTable\s*(>\}\})` $replacement
        }}
        {{ partial "contentAdapter/addPage" (dict
          "context" $
          "addedPages" $addedPages
          "content" $featsPageContent
          "kind" $featsPage.kind
          "type" $featsPage.type
          "path" (printf "%s/talenti" .path)
          "params" $featsPage.params
          )
        }}
      {{ end }}
    {{ else if eq .type "ancestry" }}
      {{ $featsPage := $addedPages.Get (printf "%s/talenti" .original.path) }}
      {{ if $featsPage }}
        {{ $featTraits := .params.featTraits | default .params.traits | default (slice) }}
        {{ $featsPageContent := $featsPage.content.value }}
        {{ $replacement := printf `$1 featTable traits="%s" $2` (delimit $featTraits ",") }}
        {{ $featsPageContent = $featsPageContent |
          replaceRE `(\{\{<)\s*rulesFeatTable\s*(>\}\})` $replacement
        }}

        {{ partial "contentAdapter/addPage" (dict
          "context" $
          "addedPages" $addedPages
          "content" $featsPageContent
          "kind" $featsPage.kind
          "type" $featsPage.type
          "path" (printf "%s/talenti" .path)
          "params" $featsPage.params
          )
        }}
      {{ end }}

      {{ $heritagesPage := $addedPages.Get (printf "%s/lignaggi" .original.path) }}
      {{ if $heritagesPage }}
        {{ $featTraits := .params.featTraits | default .params.traits | default (slice) }}
        {{ $heritagesPageContent := $heritagesPage.content.value }}
        {{ $replacement := printf `$1 featTable traits="%s" $2` (delimit $featTraits ",") }}
        {{ $heritagesPageContent = $heritagesPageContent |
          replaceRE `(\{\{<)\s*rulesFeatTable\s*(>\}\})` $replacement
        }}

        {{ partial "contentAdapter/addPage" (dict
          "context" $
          "addedPages" $addedPages
          "content" $heritagesPageContent
          "kind" $heritagesPage.kind
          "type" $heritagesPage.type
          "path" (printf "%s/lignaggi" .path)
          "params" $heritagesPage.params
          )
        }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{ define "partials/contentAdapterPathByType" }}
  {{ $base := replaceRE `^.*/([a-z\-]+)$` "$1" .path }}
  {{ $path := "" }}
  {{ if .type }}
    {{ $pathTemplate := (index (partialCached "config" "").types .type).path }}
    {{ if not $pathTemplate }}
      {{ errorf "type %v not found in config.yaml" .type }}
    {{ end }}

    {{ $context := (dict "base" $base "params" .params) }}
    {{ $pathExecuted := printf "%s/%s.txt" .path .type }}
    {{ $path = (resources.FromString .type $pathTemplate | resources.ExecuteAsTemplate $pathExecuted $context).Content }}
  {{ end }}
  {{ return $path }}
{{ end }}

{{ define "partials/contentAdapterConvertGlob" }}
  {{ return (. | replaceRE `\*\*` ".+?" | replaceRE `\*` "[^/]+?" ) }}
{{ end }}

{{ define "partials/contentAdapter/addPage" }}
  {{ $newPage := dict
    "content" (dict "mediaType" "text/markdown" "value" .content)
    "kind" .kind
    "type" (.type | default "page")
    "path" .path
    "params" (.params | default dict)
    "outputs" (slice "html" "json")
  }}
  {{ .addedPages.Set .path $newPage }}
  {{ .context.AddPage $newPage }}
{{ end }}
