{{ $content := "" }}
{{ with .page }}
  {{ $h6 := strings.Repeat (add 6 $.level | math.Min 6 | int) "#" }}
  {{ $h5 := strings.Repeat (add 5 $.level | math.Min 6 | int) "#" }}
  {{ $h4 := strings.Repeat (add 4 $.level | math.Min 6 | int) "#" }}
  {{ $h3 := strings.Repeat (add 3 $.level | math.Min 6 | int) "#" }}
  {{ $h2 := strings.Repeat (add 2 $.level | math.Min 6 | int) "#" }}
  {{ $h1 := strings.Repeat (add 1 $.level | math.Min 6 | int) "#" }}

  {{ $prevIncludeContext := .Store.Get "includeContext" }}
  {{ $includeContext := $.context.Store.Get "includeContext" | default slice }}
  {{ $newIncludeElement := dict "page" $.context "template" $.template }}
  {{ $newIncludeContext := slice | append $includeContext | append (slice $newIncludeElement) }}

  {{/* we need to trigger .RenderShortcodes to tell hugo that this page is a dependency */}}
  {{ .RenderShortcodes }}

  {{ $content = .RawContent | replaceRE `^---\r?\n\s*([\s\S]*?)\s*\r?\n---\r?\n\s*` "" }}
  {{ .Store.Set "includeContext" $newIncludeContext }}
  {{ $content = (printf "~~~\n%s~~~" $content) | .RenderString | htmlUnescape }}
  {{ .Store.Set "includeContext" $prevIncludeContext }}
  {{ $content = $content | replaceRE "^<pre.*?><code>|</code></pre>$" "" }}

  {{ if $.title }}
    {{ $content = $content | replaceRE "((?:\n|^)# ).+?([ \n]\\{.+\\})?(\\s*)" (printf `${1}%s${2}` $.title) }}
  {{ end }}

  {{/* prettier-ignore-start */}}
  {{ $content = $content | replaceRE "((?:\\n|^)(?:> )?)###### (.+?)(?:[ \\n]\\{([^{].+)\\})?(\\n\\s*)" (printf "${1}%s ${2} {index=__COUNTED__ level=6 ${3}}${4}" $h6) }}
  {{ $content = $content | replaceRE "((?:\\n|^)(?:> )?)##### (.+?)(?:[ \\n]\\{([^{].+)\\})?(\\n\\s*)" (printf "${1}%s ${2} {index=__COUNTED__ level=5 ${3}}${4}" $h5) }}
  {{ $content = $content | replaceRE "((?:\\n|^)(?:> )?)#### (.+?)(?:[ \\n]\\{([^{].+)\\})?(\\n\\s*)" (printf "${1}%s ${2} {index=__COUNTED__ level=4 ${3}}${4}" $h4) }}
  {{ $content = $content | replaceRE "((?:\\n|^)(?:> )?)### (.+?)(?:[ \\n]\\{([^{].+)\\})?(\\n\\s*)" (printf "${1}%s ${2} {index=__COUNTED__ level=3 ${3}}${4}" $h3) }}
  {{ $content = $content | replaceRE "((?:\\n|^)(?:> )?)## (.+?)(?:[ \\n]\\{([^{].+)\\})?(\\n\\s*)" (printf "${1}%s ${2} {index=__COUNTED__ level=2 ${3}}${4}" $h2) }}
  {{ $content = $content | replaceRE "((?:\\n|^)(?:> )?)# (.+?)(?:[ \\n]\\{([^{].+)\\})?(\\n\\s*)" (printf "${1}%s ${2} {index=__COUNTED__ level=1 ${3}}${4}" $h1) }}

  {{/* prettier-ignore-end */}}
  {{ $i := 0 }}
  {{ range (findRE "__COUNTED__" $content) }}
    {{ $content = replace $content "__COUNTED__" (string $i) 1 }}
    {{ $i = add $i 1 }}
  {{ end }}

  {{ if eq $.template "inlinetitle" }}
    {{ $url := .Params.canonicalURL | default .RelPermalink | replaceRE "/$" "" }}
    {{ $regexTitleAndBody := printf `(?:\n|^)(?:> )?%s (.+?)(?: -.*)?\s*(?:\{.*\})?\n\s*(?:\*\*[\s\S]+?\n---\n\s*)?([\s\S]+?)\s*(?:\n---\n|$)` $h1 }}
    {{ $match := findRESubmatch $regexTitleAndBody $content 1 }}
    {{ $title := index (index $match 0) 1 }}
    {{ $body := index (index $match 0) 2 }}
    {{ $content = printf "\n[**%s**](%s)**:** %s" $title $url $body }}
  {{ else if eq $.template "notitle" }}
    {{ $regexTitle := printf `((?:\n|^)(?:> )?%s )(.+?)(?: - (?:(\d+)[Â°+]?|(.+?)(?: (\d+))?))?(?: \{(.+)\})?(\n\s*)` $h1 }}
    {{ $content = replaceRE $regexTitle "" $content 1 }}
  {{ else if eq $.template "blockquote" }}
    {{ $content = replaceRE "(\\n|^)([^\\n]*)" "${1}> ${2}" $content }}
  {{ else if eq $.template "monsterfamily" }}
    {{ $monsterFamily := path.Base .Path }}
    {{ $appendContent := partial "shortcodes/includeAll" (dict
      "context" $.context
      "source" $.templateData.source
      "filter" (dict "params" (dict "monsterFamily" (dict "$in" $monsterFamily)))
      "sort" slice
      "level" 1
      "space" false
      "template" ""
      "templateDate" dict
      )
    }}
    {{ $content = replaceRE `(\{\{__hugo_ctx/\}\}\s*$|$)`
      (printf "\n\n%s\n\n$0" $appendContent)
      $content
    }}
  {{ end }}

  {{ $pid := int (.Key | replaceRE "^page-" "") }}
  {{ $content = print "\n{" "{__hugo_ctx pid=" $pid "}" "}\n\n" $content "\n\n{" "{__hugo_ctx/}" "}\n" }}

  {{ $isStatblock := partialCached "pf/isStatblock" .Type .Type }}
  {{ if and $isStatblock (not $.template) }}
    {{ $content = printf "<div class=\"prose sf-prose px-4 py-4 bg-black/3 dark:bg-white/3 my-5\">\n\n%s\n\n</div>" $content }}
  {{ end }}
{{ end }}

{{ return ($content | safeHTML) }}
