{{ $content := "" }}
{{ with .page }}
  {{ $h6 := strings.Repeat (add 6 $.level | math.Min 6 | int) "#" }}
  {{ $h5 := strings.Repeat (add 5 $.level | math.Min 6 | int) "#" }}
  {{ $h4 := strings.Repeat (add 4 $.level | math.Min 6 | int) "#" }}
  {{ $h3 := strings.Repeat (add 3 $.level | math.Min 6 | int) "#" }}
  {{ $h2 := strings.Repeat (add 2 $.level | math.Min 6 | int) "#" }}
  {{ $h1 := strings.Repeat (add 1 $.level | math.Min 6 | int) "#" }}

  {{ $content = .RenderShortcodes }}

  {{ if $.title }}
    {{ $content = replaceRE "((?:\n|^)# ).+?([ \n]\\{.+\\})?(\\s*)" (printf `${1}%s${2}` $.title) $content }}
  {{ end }}

  {{/* prettier-ignore-start */}}
  {{ $content = replaceRE "(\\n|^)###### (.+?)(?:[ \\n]\\{([^{].+)\\})?(\\n\\s*)" (printf "${1}%s ${2} {index=__COUNTED__ level=6 ${3}}${4}" $h6) $content }}
  {{ $content = replaceRE "(\\n|^)##### (.+?)(?:[ \\n]\\{([^{].+)\\})?(\\n\\s*)" (printf "${1}%s ${2} {index=__COUNTED__ level=5 ${3}}${4}" $h5) $content }}
  {{ $content = replaceRE "(\\n|^)#### (.+?)(?:[ \\n]\\{([^{].+)\\})?(\\n\\s*)" (printf "${1}%s ${2} {index=__COUNTED__ level=4 ${3}}${4}" $h4) $content }}
  {{ $content = replaceRE "(\\n|^)### (.+?)(?:[ \\n]\\{([^{].+)\\})?(\\n\\s*)" (printf "${1}%s ${2} {index=__COUNTED__ level=3 ${3}}${4}" $h3) $content }}
  {{ $content = replaceRE "(\\n|^)## (.+?)(?:[ \\n]\\{([^{].+)\\})?(\\n\\s*)" (printf "${1}%s ${2} {index=__COUNTED__ level=2 ${3}}${4}" $h2) $content }}
  {{ $content = replaceRE "(\\n|^)# (.+?)(?:[ \\n]\\{([^{].+)\\})?(\\n\\s*)" (printf "${1}%s ${2} {index=__COUNTED__ level=1 ${3}}${4}" $h1) $content }}

  {{/* prettier-ignore-end */}}
  {{ $i := 0 }}
  {{ range (findRE "__COUNTED__" $content) }}
    {{ $content = replace $content "__COUNTED__" (string $i) 1 }}
    {{ $i = add $i 1 }}
  {{ end }}

  {{ $searchFirstTitle := printf "((?:\n|^)%s )(.+?)(?: \\{(.+)\\})?(\n\\s*)" $h1 }}

  {{ if eq $.template "inlinetitle" }}
    {{ $url := .Params.canonicalURL | default .RelPermalink | replaceRE "/$" "" }}
    {{ $replacement := printf "\n[**${2}**](%s)**:** " $url }}
    {{ $content = replaceRE $searchFirstTitle $replacement $content 1 }}
  {{ else if eq $.template "notitle" }}
    {{ $content = replaceRE $searchFirstTitle "" $content 1 }}
  {{ else if eq $.template "blockquote" }}
    {{ $content = replaceRE "(\\n|^)([^\\n]*)" "${1}> ${2}" $content }}
  {{ else if eq $.template "monsterfamily" }}
    {{ $monsterFamily := path.Base .Path }}
    {{ $appendContent := partial "shortcodes/includeAll" (dict
      "context" $.context
      "source" $.templateData.source
      "filter" (dict "params" (dict "monsterFamily" (dict "$contains" $monsterFamily)))
      "sort" slice
      "level" 1
      "space" false
      "template" ""
      "templateDate" dict
      )
    }}
    {{ $content = replaceRE "(\\{\\{__hugo_ctx/\\}\\}\\s*$|$)\\n?"
      (printf "\n\n%s\n\n$0" $appendContent)
      $content
    }}
  {{ end }}
{{ end }}
{{ return ($content | safeHTML) }}
